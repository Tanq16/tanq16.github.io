<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Authentication and 2FA" /><meta property="og:locale" content="en" /><meta name="description" content="Authentication" /><meta property="og:description" content="Authentication" /><link rel="canonical" href="https://tanishq.page/blog/posts/authentication-2fa/" /><meta property="og:url" content="https://tanishq.page/blog/posts/authentication-2fa/" /><meta property="og:site_name" content="Tanishq Rupaal" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-10-13T02:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Authentication and 2FA" /><meta name="twitter:site" content="@etheriosking" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-10-13T02:00:00-05:00","datePublished":"2020-10-13T02:00:00-05:00","description":"Authentication","headline":"Authentication and 2FA","mainEntityOfPage":{"@type":"WebPage","@id":"https://tanishq.page/blog/posts/authentication-2fa/"},"url":"https://tanishq.page/blog/posts/authentication-2fa/"}</script><title>Authentication and 2FA | Tanishq Rupaal</title><link rel="apple-touch-icon" sizes="180x180" href="/blog/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/blog/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/blog/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/blog/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/blog/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tanishq Rupaal"><meta name="application-name" content="Tanishq Rupaal"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/blog/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css"><link rel="stylesheet" href="/blog/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/blog/" class="mx-auto"> <img src="/blog/assets/Abstract.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/blog/">Tanishq Rupaal</a></div><div class="site-subtitle font-italic">Cybersecurity Professional</div></div><ul class="w-100"><li class="nav-item"> <a href="/blog/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/blog/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/blog/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/blog/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/blog/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/tanq16" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/etheriosking" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['dragonking47','proton.me'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://linkedin.com/in/tanishqrupaal" aria-label="linkedin" target="_blank" rel="noopener noreferrer"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/blog/"> Home </a> </span> <span>Authentication and 2FA</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Authentication and 2FA</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1602572400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 13, 2020 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/etheriosking">Tanishq Rupaal</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1542 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><h2 id="authentication"><span class="mr-2">Authentication</span><a href="#authentication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="basic-authentication"><span class="mr-2">Basic Authentication</span><a href="#basic-authentication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>It is the simplest authentication mechanism which is part of the HTTP protocol. It is a challenge response scheme where the server challenges the client to provide information to access a resource. The username and password is encoded using base64 and the value is set in the Authorization header and send it along in each HTTP request. Example → <code class="language-plaintext highlighter-rouge">Authorization: Basic XAAUVBBhHI87I==</code> . It is easy to implement and thus has faster APIs. In a non-SSL network, the encoding is basically useless. Sending the credentials in every HTTP request increases the attack surface.</p><h3 id="digest-based-authentication"><span class="mr-2">Digest based Authentication</span><a href="#digest-based-authentication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This is an upgraded version of Basic Authentication. Instead of the base64 encoded strings, the server provides a digest for the client to use while encoding the username and password. Thus, the encoding is not universally known. When a client requests a resource without any authorization, the server sets the header with a certain digest information. The credentials are hashed using the digest and sent to the server along with the new request, which is decoded by the server and it grants the resource for valid credentials. This is still vulnerable to Man in The Middle attacks. It also requires 2 requests to a resource, the first of which is always wasted.</p><h3 id="cookiesession-based-authentication"><span class="mr-2">Cookie/Session based Authentication</span><a href="#cookiesession-based-authentication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This is most commonly used in web apps. The credentials (username and password) are set in the parameters of a form and sent along in a request. The server validates the login and creates a cookie which is sent back in the response. The client uses this cookie to make future requests. This eliminates the need to send credentials in every request while enabling state maintenance in a stateless system. The validity of a cookie can be revoked anytime. It is generally useful for only Single domain systems. For multiple web apps and a separate client, the issue of CSRF arises. The session information is required to be stored in a database which questions the scalability.</p><h3 id="token-based-authentication"><span class="mr-2">Token based Authentication</span><a href="#token-based-authentication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This is a form of stateless authentication. Instead of sending credentials for authentication, a server generated token is used. OAuth, JWT and OpenID are types of token based authentication.</p><p><strong>JWT →</strong> When a user submits a username and password, the server validates it and returns a signed Jason Web Token. The token is used to allow future requests. The server doesn’t bear the overhead of session information. It solves the issue of CSRF. However, the access to a user cannot be revoked and the safety of the token relies entirely on the consumer.</p><p><strong>OAuth2 →</strong> This is an advanced token based authentication. Examples include signing with Facebook/Google/Apple. The user sends an authentication requests to Google/Facebook. Given the user has an account on Google or Facebook, the server responds with an authorization grant. Using this, the client requests an access token from the Authentication server. This token is sent to the application server, which validates the access token from the authentication server. Then the user is granted access to the resource.</p><p><strong>SSO →</strong> Personal computers are a classic example of Single Sign On systems i.e., enter password once to get access to all the apps. Google is another example → A user trying to access Google forms sends a request to the forms service, which in turn calls the authentication service to make sure that the user is in fact logged in. If the user is not authenticated, then the service presents the login screen to authenticate the user. The advantage is that users need to remember only one password and it is secure because all services are being handled by one master authentication service.</p><h2 id="two-factor-authentication"><span class="mr-2">Two Factor Authentication</span><a href="#two-factor-authentication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This is a subset of multi-factor authentication. TOTPs, Validation emails, Location (like GPay), Inherent factors such as Fingerprint and Iris scan, Knowledge based such as security questions are some of the factors used for 2FA/MFA. A threat model is essentially a structured representation of all the information that affects the security of an application. In essence, it is a view of the application and its environment through security glasses. It is a family of activities for improving security by identifying objectives and vulnerabilities, and then defining countermeasures to prevent, or mitigate the effects of, threats to the system.</p><h3 id="2fa-using-totps-basic-implementation--google-authenticator"><span class="mr-2">2FA using TOTPs (Basic Implementation → Google Authenticator)</span><a href="#2fa-using-totps-basic-implementation--google-authenticator" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>2FA is a new method for generating not normal OTPs, but <strong>TOTPs (Time based One Time Passwords)</strong>. Providers for 2FA services are → Google Authenticator, LastPass Authenticator, Microsoft Authenticator, Authy by Twilio, etc. TOTP is an algorithm that factors in the current time to generate a unique one-time password. TOTPs are secure because →</p><ol><li>The password changes every n number of seconds (usually, 30 seconds), preventing eavesdroppers from using the same password later if they’re able to get a hold of it.<li>The password may be generated by an app on the user’s phone, making it more difficult for an attacker to acquire the password, as the user’s phone is usually by his/her side, unlike carrier messages which are susceptible to SIM theft.</ol><p>TOTPs are user friendly because the user need only enter the password from an app or allow logins for integrated authenticators. TOTPs rely on the algorithm for <strong>HMAC based OTPs (HOTPs)</strong>. This document is an explanation on the implementation of both these algorithms as used by Google in Google Authenticator.</p><h3 id="generating-secret"><span class="mr-2">Generating Secret</span><a href="#generating-secret" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The first step is the creation of an application specific secret that will be used to verify the OTPs. This key will also be shared with the Authenticator app. It is using this secret key that the apps know what OTPs to generate for the authentication in apps or websites. One way of generating the secret is to generate a completely random buffer of data and encode it to base32. This can be done in NodeJS as follows →</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">crypto</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">base32</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">hi-base32</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">function</span> <span class="nf">generateSecret</span><span class="p">(</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">const</span> <span class="nx">randomBuffer</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nf">randomBytes</span><span class="p">(</span><span class="nx">length</span><span class="p">);</span>
   <span class="k">return</span> <span class="nx">base32</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="nx">randomBuffer</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sr">/=/g</span><span class="p">,</span> <span class="dl">''</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="generating-hotps"><span class="mr-2">Generating HOTPs</span><a href="#generating-hotps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This step requires a secret key and a counter value. The secret is generated as shown in the above step. The counter value will be provided to the app when TOTPs are generated. The HOTP function accepts two arguments → <code class="language-plaintext highlighter-rouge">secret</code> and <code class="language-plaintext highlighter-rouge">counter</code>. The function first decodes the secret from base32. Then it creates a buffer from the counter value. A SHA-1 (in case of Google Authenticator) is used with the secret as the key and the buffer as the parameter. The HMAC result produced will be a 20 byte string. A 4 byte binary code is then extracted using <strong>dynamic truncation</strong>. Then, the first 6 digits of this code is extracted to get the final HOTP value. This process can be shown as a code block as follows →</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">crypto</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">base32</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">hi-base32</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">function</span> <span class="nf">generateHOTP</span><span class="p">(</span><span class="nx">secret</span><span class="p">,</span> <span class="nx">counter</span><span class="p">)</span> <span class="p">{</span>
 <span class="kd">const</span> <span class="nx">decodedSecret</span> <span class="o">=</span> <span class="nx">base32</span><span class="p">.</span><span class="nx">decode</span><span class="p">.</span><span class="nf">asBytes</span><span class="p">(</span><span class="nx">secret</span><span class="p">);</span>
 <span class="kd">const</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nf">alloc</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
 <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">buffer</span><span class="p">[</span><span class="mi">7</span> <span class="o">-</span> <span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
    <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="c1">// Step 1: Generate an HMAC-SHA-1 value</span>
 <span class="kd">const</span> <span class="nx">hmac</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nf">createHmac</span><span class="p">(</span><span class="dl">'</span><span class="s1">sha1</span><span class="dl">'</span><span class="p">,</span> <span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">decodedSecret</span><span class="p">));</span>
 <span class="nx">hmac</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
 <span class="kd">const</span> <span class="nx">hmacResult</span> <span class="o">=</span> <span class="nx">hmac</span><span class="p">.</span><span class="nf">digest</span><span class="p">();</span>

 <span class="c1">// Step 2: Generate a 4-byte string (Dynamic Truncation)</span>
 <span class="kd">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="nf">dynamicTruncationFn</span><span class="p">(</span><span class="nx">hmacResult</span><span class="p">);</span>

 <span class="c1">// Step 3: Compute an HOTP value</span>
 <span class="k">return</span> <span class="nx">code</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">dynamicTruncationFn</span><span class="p">(</span><span class="nx">hmacValue</span><span class="p">)</span> <span class="p">{</span>
 <span class="kd">const</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">hmacValue</span><span class="p">[</span><span class="nx">hmacValue</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

 <span class="k">return </span><span class="p">(</span>
    <span class="p">((</span><span class="nx">hmacValue</span><span class="p">[</span><span class="nx">offset</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
    <span class="p">((</span><span class="nx">hmacValue</span><span class="p">[</span><span class="nx">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
    <span class="p">((</span><span class="nx">hmacValue</span><span class="p">[</span><span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
    <span class="p">(</span><span class="nx">hmacValue</span><span class="p">[</span><span class="nx">offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
 <span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="generating-totps"><span class="mr-2">Generating TOTPs</span><a href="#generating-totps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The algorithm for generating TOTPs uses current time with a time-step of 30 seconds as the counter value in the <code class="language-plaintext highlighter-rouge">generateHOTP</code> function. The counter value can be generated as follows →</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">counter</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">/</span> <span class="mi">30000</span><span class="p">);</span>
</pre></table></code></div></div><p>The function to generate the TOTP also accepts a window parameter which helps get the TOTP of any time window from the current time. Example → TOTP 2 mins back was at window=-4. The function can be written as follows →</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">generateTOTP</span><span class="p">(</span><span class="nx">secret</span><span class="p">,</span> <span class="nb">window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">const</span> <span class="nx">counter</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">/</span> <span class="mi">30000</span><span class="p">);</span>
   <span class="k">return</span> <span class="nf">generateHOTP</span><span class="p">(</span><span class="nx">secret</span><span class="p">,</span> <span class="nx">counter</span> <span class="o">+</span> <span class="nb">window</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="verification-of-totps"><span class="mr-2">Verification of TOTPs</span><a href="#verification-of-totps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The secret key is used to verify the TOTPs. The <code class="language-plaintext highlighter-rouge">generateTOTP</code> function is used to calculate the TOTP again and the value is checked to see if it matches or not. To improve experience of the user, the previous window’s TOTP is also checked. Given variable <code class="language-plaintext highlighter-rouge">token</code> is the generated TOTP from the app, the verification function can be written as follows →</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">verifyTOTP</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">secret</span><span class="p">,</span> <span class="nb">window</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if </span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="o">+</span><span class="nb">window</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Window size is too large</span><span class="dl">'</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">errorWindow</span> <span class="o">=</span> <span class="o">-</span><span class="nb">window</span><span class="p">;</span> <span class="nx">errorWindow</span> <span class="o">&lt;=</span> <span class="o">+</span><span class="nb">window</span><span class="p">;</span> <span class="nx">errorWindow</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">totp</span> <span class="o">=</span> <span class="nf">generateTOTP</span><span class="p">(</span><span class="nx">secret</span><span class="p">,</span> <span class="nx">errorWindow</span><span class="p">);</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="nx">totp</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="resources"><span class="mr-2">Resources</span><a href="#resources" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ol><li><a href="https://hackernoon.com/how-to-implement-google-authenticator-two-factor-auth-in-javascript-091wy3vh3">Hacker Noon: How To Implement Google Authenticator Two Factor Auth in JavaScript</a><li><a href="https://medium.com/@mikesparr/security-models-authentication-and-authorization-explained-7c227f228723">Security Models: Authentication and Authorization Explained</a></ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/blog/categories/computers-and-security/'>Computers and Security</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/blog/tags/security/" class="post-tag no-text-decoration" >security</a> <a href="/blog/tags/authentication/" class="post-tag no-text-decoration" >authentication</a> <a href="/blog/tags/mfa/" class="post-tag no-text-decoration" >mfa</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Authentication%20and%202FA%20-%20Tanishq%20Rupaal&url=https%3A%2F%2Ftanishq.page%2Fblog%2Fposts%2Fauthentication-2fa%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Authentication%20and%202FA%20-%20Tanishq%20Rupaal&u=https%3A%2F%2Ftanishq.page%2Fblog%2Fposts%2Fauthentication-2fa%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Ftanishq.page%2Fblog%2Fposts%2Fauthentication-2fa%2F&text=Authentication%20and%202FA%20-%20Tanishq%20Rupaal" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Ftanishq.page%2Fblog%2Fposts%2Fauthentication-2fa%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/blog/tags/lab/">lab</a> <a class="post-tag" href="/blog/tags/offsec-proving-grounds/">offsec-proving-grounds</a> <a class="post-tag" href="/blog/tags/oscp/">oscp</a> <a class="post-tag" href="/blog/tags/home-lab/">home-lab</a> <a class="post-tag" href="/blog/tags/productivity/">productivity</a> <a class="post-tag" href="/blog/tags/security/">security</a> <a class="post-tag" href="/blog/tags/aws/">aws</a> <a class="post-tag" href="/blog/tags/programming/">programming</a> <a class="post-tag" href="/blog/tags/github/">github</a> <a class="post-tag" href="/blog/tags/linux/">linux</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/posts/flaws-1/"><div class="card-body"> <em class="small" data-ts="1648710000" data-df="ll" > Mar 31, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>flAWS 1</h3><div class="text-muted small"><p> Level 1 This level is buckets of fun. See if you can find the first sub-domain. Begin with doing a dig of flaws.cloud, which returns the following → 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17...</p></div></div></a></div><div class="card"> <a href="/blog/posts/pentester-academy-aws-iam/"><div class="card-body"> <em class="small" data-ts="1651129200" data-df="ll" > Apr 28, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Pentester Academy AWS IAM Attack Lab</h3><div class="text-muted small"><p> Enumeration To get information about current caller → 1 awsn sts get-identity-caller List and see last uses for access keys → 1 2 3 4 5 6 7 8 9 10 11 # List all access keys awsn ...</p></div></div></a></div><div class="card"> <a href="/blog/posts/pentester-academy-aws-s3/"><div class="card-body"> <em class="small" data-ts="1651129200" data-df="ll" > Apr 28, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Pentester Academy AWS S3 Attack Lab</h3><div class="text-muted small"><p> Enumeration List buckets and get region for bucket → 1 2 3 4 5 # List buckets using s3api awsn s3api list-buckets | jq &#39;.Buckets[] | .Name&#39; | tr -d &quot;\&quot;&quot; # Get region for bucket a...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/posts/xss-attack-lab/" class="btn btn-outline-primary" prompt="Older"><p>XSS Attack Lab - SeedLabs</p></a> <a href="/blog/posts/threat-modeling/" class="btn btn-outline-primary" prompt="Newer"><p>Introduction to Threat Modeling</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/blog/tags/lab/">lab</a> <a class="post-tag" href="/blog/tags/offsec-proving-grounds/">offsec-proving-grounds</a> <a class="post-tag" href="/blog/tags/oscp/">oscp</a> <a class="post-tag" href="/blog/tags/home-lab/">home-lab</a> <a class="post-tag" href="/blog/tags/productivity/">productivity</a> <a class="post-tag" href="/blog/tags/security/">security</a> <a class="post-tag" href="/blog/tags/aws/">aws</a> <a class="post-tag" href="/blog/tags/programming/">programming</a> <a class="post-tag" href="/blog/tags/github/">github</a> <a class="post-tag" href="/blog/tags/linux/">linux</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/etheriosking">Tanishq Rupaal</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/blog/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1.11.6/dayjs.min.js,npm/dayjs@1.11.6/locale/en.min.js,npm/dayjs@1.11.6/plugin/relativeTime.min.js,npm/dayjs@1.11.6/plugin/localizedFormat.min.js"></script> <script defer src="/blog/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/blog/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-B88HEPZBVJ"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-B88HEPZBVJ'); }); </script>
